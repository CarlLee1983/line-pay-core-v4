name: PR Labeler

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  label:
    name: Auto Label PR
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Label PR based on files changed
        uses: actions/labeler@v6
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml
          sync-labels: true

      - name: Label PR based on title
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request.title.toLowerCase();
            const labels = [];

            // Auto-label based on conventional commit type in title
            if (title.startsWith('feat:') || title.includes('[feat]')) {
              labels.push('enhancement');
            } else if (title.startsWith('fix:') || title.includes('[fix]')) {
              labels.push('bug');
            } else if (title.startsWith('docs:') || title.includes('[docs]')) {
              labels.push('documentation');
            } else if (title.startsWith('test:') || title.includes('[test]')) {
              labels.push('test');
            } else if (title.startsWith('refactor:') || title.includes('[refactor]')) {
              labels.push('refactoring');
            } else if (title.startsWith('perf:') || title.includes('[perf]')) {
              labels.push('performance');
            } else if (title.startsWith('chore:') || title.includes('[chore]')) {
              labels.push('maintenance');
            }

            // Add breaking change label
            if (title.includes('breaking') || title.includes('!:')) {
              labels.push('breaking-change');
            }

            if (labels.length > 0) {
              github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: labels
              });
            }

      - name: Check PR size
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions;
            const deletions = pr.deletions;
            const total = additions + deletions;

            let sizeLabel = '';
            if (total < 10) {
              sizeLabel = 'size/XS';
            } else if (total < 50) {
              sizeLabel = 'size/S';
            } else if (total < 200) {
              sizeLabel = 'size/M';
            } else if (total < 500) {
              sizeLabel = 'size/L';
            } else {
              sizeLabel = 'size/XL';
            }

            // Remove old size labels
            const { data: currentLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });

            const sizeLabelRegex = /^size\//;
            for (const label of currentLabels) {
              if (sizeLabelRegex.test(label.name)) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  name: label.name
                });
              }
            }

            // Add new size label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: [sizeLabel]
            });
